<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - إدارة الرحلة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .bg-turquoise { background-color: #40E0D0; }
        .text-turquoise { color: #40E0D0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-white shadow-md p-6 mb-10">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-turquoise">لوحة تحكم الرحلة</h1>
            <div class="flex space-x-reverse space-x-4">
                <button onclick="showSection('participants')" class="px-4 py-2 rounded-lg bg-turquoise text-white">المشاركون</button>
                <button onclick="showSection('features')" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">إدارة الصور</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6">

        <!-- Participants Section -->
        <div id="participantsSection" class="section">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right border-collapse">
                        <thead>
                            <tr class="bg-turquoise text-white">
                                <th class="p-4 border-b">الاسم واللقب</th>
                                <th class="p-4 border-b">رقم الهاتف</th>
                                <th class="p-4 border-b">تاريخ الميلاد</th>
                                <th class="p-4 border-b">الجنس</th>
                                <th class="p-4 border-b">مكان الميلاد</th>
                                <th class="p-4 border-b">السكن</th>
                                <th class="p-4 border-b">الوظيفة</th>
                                <th class="p-4 border-b">إسعافات أولية؟</th>
                                <th class="p-4 border-b">تاريخ التسجيل</th>
                            </tr>
                        </thead>
                        <tbody id="participantsList">
                            <tr><td colspan="9" class="p-10 text-center text-gray-500 italic">جاري التحميل...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div id="featuresSection" class="section hidden">
            <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold mb-8 text-center">تحديث صور المميزات</h2>
                <form id="featuresForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label class="block font-bold mb-2">فندق 4 نجوم (رابط الصورة)</label>
                            <input type="url" name="hotel" required class="w-full p-3 rounded-lg border">
                        </div>
                        <div>
                            <label class="block font-bold mb-2">شواطئ فيروزية (رابط الصورة)</label>
                            <input type="url" name="beaches" required class="w-full p-3 rounded-lg border">
                        </div>
                        <div>
                            <label class="block font-bold mb-2">حمامات معدنية (رابط الصورة)</label>
                            <input type="url" name="baths" required class="w-full p-3 rounded-lg border">
                        </div>
                        <div>
                            <label class="block font-bold mb-2">ألعاب مائية وملاهي (رابط الصورة)</label>
                            <input type="url" name="park" required class="w-full p-3 rounded-lg border">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-turquoise text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 transition">حفظ التغييرات</button>
                </form>
            </div>
        </div>

    </div>

    <script>
        const ADMIN_TOKEN = 'admin-dashboard-access-key-777';

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id + 'Section').classList.remove('hidden');
        }

        async function loadParticipants() {
            const res = await fetch('/api/participants', {
                headers: { 'X-Admin-Token': ADMIN_TOKEN }
            });
            if (!res.ok) {
                alert('خطأ في التفويض');
                return;
            }
            const data = await res.json();
            const body = document.getElementById('participantsList');
            body.innerHTML = '';
            data.reverse().forEach(p => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';

                const addCell = (text, cls = 'p-4') => {
                    const td = document.createElement('td');
                    td.className = cls;
                    td.textContent = text;
                    return td;
                };

                row.appendChild(addCell(p.fullName, 'p-4 font-bold'));
                const tel = addCell(p.phoneNumber, 'p-4'); tel.dir = 'ltr'; row.appendChild(tel);
                row.appendChild(addCell(p.birthDate));
                row.appendChild(addCell(p.gender));
                row.appendChild(addCell(p.birthPlace));
                row.appendChild(addCell(p.currentAddress));
                row.appendChild(addCell(p.jobType));

                const fa = document.createElement('td'); fa.className = 'p-4';
                fa.innerHTML = `<span class="px-2 py-1 rounded ${p.firstAid==='نعم'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${p.firstAid}</span>`;
                row.appendChild(fa);

                row.appendChild(addCell(new Date(p.timestamp).toLocaleString('ar-DZ'), 'p-4 text-xs text-gray-500'));
                body.appendChild(row);
            });
        }

        async function loadFeatures() {
            const res = await fetch('/api/features');
            const data = await res.json();
            const form = document.getElementById('featuresForm');
            form.hotel.value = data.hotel.image;
            form.beaches.value = data.beaches.image;
            form.baths.value = data.baths.image;
            form.park.value = data.park.image;
        }

        document.getElementById('featuresForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const update = {
                hotel: { title: "فندق 4 نجوم", image: formData.get('hotel') },
                beaches: { title: "شواطئ فيروزية", image: formData.get('beaches') },
                baths: { title: "حمامات معدنية", image: formData.get('baths') },
                park: { title: "ألعاب مائية وملاهي", image: formData.get('park') }
            };
            const res = await fetch('/api/features', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Token': ADMIN_TOKEN
                },
                body: JSON.stringify(update)
            });
            if (res.ok) alert('تم التحديث بنجاح');
            else alert('فشل التحديث');
        };

        loadParticipants();
        loadFeatures();
    </script>
</body>
</html>
