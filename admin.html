<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - إدارة الرحلة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .bg-turquoise { background-color: #40E0D0; }
        .text-turquoise { color: #40E0D0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-white shadow-md p-6 mb-10">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-turquoise">لوحة تحكم الرحلة</h1>
            <div class="flex space-x-reverse space-x-4">
                <button onclick="showSection('participants')" class="px-4 py-2 rounded-lg bg-turquoise text-white">المشاركون</button>
                <button onclick="showSection('features')" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">إدارة الصور</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6">

        <!-- Participants Section -->
        <div id="participantsSection" class="section">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-right border-collapse">
                        <thead>
                            <tr class="bg-turquoise text-white">
                                <th class="p-4 border-b">الاسم واللقب</th>
                                <th class="p-4 border-b">رقم الهاتف</th>
                                <th class="p-4 border-b">تاريخ الميلاد</th>
                                <th class="p-4 border-b">الجنس</th>
                                <th class="p-4 border-b">مكان الميلاد</th>
                                <th class="p-4 border-b">السكن</th>
                                <th class="p-4 border-b">الوظيفة</th>
                                <th class="p-4 border-b">إسعافات أولية؟</th>
                                <th class="p-4 border-b">التاريخ</th>
                            </tr>
                        </thead>
                        <tbody id="participantsList">
                            <tr><td colspan="9" class="p-10 text-center text-gray-500 italic">جاري التحميل...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div id="featuresSection" class="section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Feature Category Card -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-turquoise">فندق 4 نجوم</h3>
                    <div class="flex items-center space-x-reverse space-x-2 mb-4">
                        <input type="file" id="file-hotel" class="hidden" onchange="uploadImage('hotel', this)">
                        <label for="file-hotel" class="cursor-pointer bg-turquoise text-white px-4 py-2 rounded-lg hover:opacity-90 transition">إضافة صورة +</label>
                    </div>
                    <div id="gallery-hotel" class="grid grid-cols-3 gap-3"></div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-turquoise">شواطئ فيروزية</h3>
                    <div class="flex items-center space-x-reverse space-x-2 mb-4">
                        <input type="file" id="file-beaches" class="hidden" onchange="uploadImage('beaches', this)">
                        <label for="file-beaches" class="cursor-pointer bg-turquoise text-white px-4 py-2 rounded-lg hover:opacity-90 transition">إضافة صورة +</label>
                    </div>
                    <div id="gallery-beaches" class="grid grid-cols-3 gap-3"></div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-turquoise">حمامات معدنية</h3>
                    <div class="flex items-center space-x-reverse space-x-2 mb-4">
                        <input type="file" id="file-baths" class="hidden" onchange="uploadImage('baths', this)">
                        <label for="file-baths" class="cursor-pointer bg-turquoise text-white px-4 py-2 rounded-lg hover:opacity-90 transition">إضافة صورة +</label>
                    </div>
                    <div id="gallery-baths" class="grid grid-cols-3 gap-3"></div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-turquoise">ألعاب مائية وملاهي</h3>
                    <div class="flex items-center space-x-reverse space-x-2 mb-4">
                        <input type="file" id="file-park" class="hidden" onchange="uploadImage('park', this)">
                        <label for="file-park" class="cursor-pointer bg-turquoise text-white px-4 py-2 rounded-lg hover:opacity-90 transition">إضافة صورة +</label>
                    </div>
                    <div id="gallery-park" class="grid grid-cols-3 gap-3"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const ADMIN_TOKEN = 'admin-dashboard-access-key-777';

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id + 'Section').classList.remove('hidden');
        }

        async function loadParticipants() {
            const res = await fetch('/api/participants', { headers: { 'X-Admin-Token': ADMIN_TOKEN } });
            const data = await res.json();
            const body = document.getElementById('participantsList');
            body.innerHTML = '';
            data.forEach(p => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';

                const addCell = (text, cls = 'p-4') => {
                    const td = document.createElement('td');
                    td.className = cls;
                    td.textContent = text;
                    return td;
                };

                row.appendChild(addCell(p.fullName, 'p-4 font-bold'));
                const tel = addCell(p.phoneNumber, 'p-4'); tel.dir = 'ltr'; row.appendChild(tel);
                row.appendChild(addCell(p.birthDate));
                row.appendChild(addCell(p.gender));
                row.appendChild(addCell(p.birthPlace));
                row.appendChild(addCell(p.currentAddress));
                row.appendChild(addCell(p.jobType));

                const fa = document.createElement('td'); fa.className = 'p-4';
                fa.innerHTML = `<span class="px-2 py-1 rounded ${p.firstAid==='نعم'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${p.firstAid}</span>`;
                row.appendChild(fa);

                row.appendChild(addCell(new Date(p.timestamp).toLocaleString('ar-DZ'), 'p-4 text-xs text-gray-500'));
                body.appendChild(row);
            });
        }

        async function loadGalleries() {
            const res = await fetch('/api/admin-features', { headers: { 'X-Admin-Token': ADMIN_TOKEN } });
            const allImages = await res.json();

            ['hotel', 'beaches', 'baths', 'park'].forEach(cat => {
                const container = document.getElementById('gallery-' + cat);
                container.innerHTML = '';
                allImages.filter(img => img.category === cat).forEach(img => {
                    const div = document.createElement('div');
                    div.className = 'relative group aspect-square';
                    div.innerHTML = `
                        <img src="/uploads/${img.filename}" class="w-full h-full object-cover rounded-xl shadow-md">
                        <button onclick="deleteImage(${img.id})" class="absolute -top-2 -right-2 bg-red-500 text-white w-7 h-7 rounded-full flex items-center justify-center shadow-lg hover:bg-red-600 transition">&times;</button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        async function uploadImage(category, input) {
            if (!input.files[0]) return;
            const formData = new FormData();
            formData.append('image', input.files[0]);
            formData.append('category', category);

            const res = await fetch('/api/upload-image', {
                method: 'POST',
                headers: { 'X-Admin-Token': ADMIN_TOKEN },
                body: formData
            });
            if (res.ok) {
                input.value = '';
                loadGalleries();
            } else {
                alert('فشل في رفع الصورة');
            }
        }

        async function deleteImage(id) {
            if (confirm('هل تريد حذف هذه الصورة؟')) {
                await fetch('/api/delete-image/' + id, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Token': ADMIN_TOKEN }
                });
                loadGalleries();
            }
        }

        loadParticipants();
        loadGalleries();
    </script>
</body>
</html>
